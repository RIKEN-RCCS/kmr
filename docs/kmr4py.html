<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>kmr4py API documentation</title>
    <meta name="description" content="Python Binding for KMR Map-Reduce Library.  This provides
straightforward wrappers to the C routines..." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#kmr4py.force_null_terminate_in_cstring">force_null_terminate_in_cstring</a></li>
    <li class="mono"><a href="#kmr4py.ignore_exceptions_in_map_fn">ignore_exceptions_in_map_fn</a></li>
    <li class="mono"><a href="#kmr4py.kmrso">kmrso</a></li>
    <li class="mono"><a href="#kmr4py.kmrso_name">kmrso_name</a></li>
    <li class="mono"><a href="#kmr4py.kmrversion">kmrversion</a></li>
    <li class="mono"><a href="#kmr4py.print_backtrace_in_map_fn">print_backtrace_in_map_fn</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#kmr4py.fin">fin</a></li>
    <li class="mono"><a href="#kmr4py.listify">listify</a></li>
    <li class="mono"><a href="#kmr4py.warning_function">warning_function</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#kmr4py.KMR">KMR</a></span>
        
          
  <ul>
    <li class="mono"><a href="#kmr4py.KMR.__init__">__init__</a></li>
    <li class="mono"><a href="#kmr4py.KMR.create_kvs">create_kvs</a></li>
    <li class="mono"><a href="#kmr4py.KMR.dismiss">dismiss</a></li>
    <li class="mono"><a href="#kmr4py.KMR.free">free</a></li>
    <li class="mono"><a href="#kmr4py.KMR.get_spawner_communicator">get_spawner_communicator</a></li>
    <li class="mono"><a href="#kmr4py.KMR.make_kvs">make_kvs</a></li>
    <li class="mono"><a href="#kmr4py.KMR.reply_to_spawner">reply_to_spawner</a></li>
    <li class="mono"><a href="#kmr4py.KMR.send_kvs_to_spawner">send_kvs_to_spawner</a></li>
    <li class="mono"><a href="#kmr4py.KMR.set_option">set_option</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#kmr4py.KVS">KVS</a></span>
        
          
  <ul>
    <li class="mono"><a href="#kmr4py.KVS.__init__">__init__</a></li>
    <li class="mono"><a href="#kmr4py.KVS.add">add</a></li>
    <li class="mono"><a href="#kmr4py.KVS.add_kv">add_kv</a></li>
    <li class="mono"><a href="#kmr4py.KVS.add_kv_done">add_kv_done</a></li>
    <li class="mono"><a href="#kmr4py.KVS.concatenate">concatenate</a></li>
    <li class="mono"><a href="#kmr4py.KVS.distribute">distribute</a></li>
    <li class="mono"><a href="#kmr4py.KVS.free">free</a></li>
    <li class="mono"><a href="#kmr4py.KVS.get_element_count">get_element_count</a></li>
    <li class="mono"><a href="#kmr4py.KVS.get_field_type">get_field_type</a></li>
    <li class="mono"><a href="#kmr4py.KVS.local_element_count">local_element_count</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map">map</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_for_some">map_for_some</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_ms">map_ms</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_ms_commands">map_ms_commands</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_on_rank_zero">map_on_rank_zero</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_once">map_once</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_parallel_processes">map_parallel_processes</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_processes">map_processes</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_rank_by_rank">map_rank_by_rank</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_serial_processes">map_serial_processes</a></li>
    <li class="mono"><a href="#kmr4py.KVS.map_via_spawn">map_via_spawn</a></li>
    <li class="mono"><a href="#kmr4py.KVS.read_file_by_segments">read_file_by_segments</a></li>
    <li class="mono"><a href="#kmr4py.KVS.read_files_reassemble">read_files_reassemble</a></li>
    <li class="mono"><a href="#kmr4py.KVS.reduce">reduce</a></li>
    <li class="mono"><a href="#kmr4py.KVS.reduce_as_one">reduce_as_one</a></li>
    <li class="mono"><a href="#kmr4py.KVS.reduce_for_some">reduce_for_some</a></li>
    <li class="mono"><a href="#kmr4py.KVS.replicate">replicate</a></li>
    <li class="mono"><a href="#kmr4py.KVS.restore">restore</a></li>
    <li class="mono"><a href="#kmr4py.KVS.reverse">reverse</a></li>
    <li class="mono"><a href="#kmr4py.KVS.save">save</a></li>
    <li class="mono"><a href="#kmr4py.KVS.shuffle">shuffle</a></li>
    <li class="mono"><a href="#kmr4py.KVS.sort">sort</a></li>
    <li class="mono"><a href="#kmr4py.KVS.sort_locally">sort_locally</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">kmr4py</span> module</h1>
  <p>Python Binding for KMR Map-Reduce Library.  This provides
straightforward wrappers to the C routines.  See more about KMR at
"http://mt.r-ccs.riken.jp/kmr".  All key-value data is stored in C
structures after encoding/decoding Python objects to byte arrays in C.
The documentation in Python is minimum, so please refer to the
documentation in C.  It works with Python3 (possibly 3.4 and later),
but not with 2.x.</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py" class="source">
    <div class="codehilite"><pre><span></span><span class="c1">## kmr4py.py</span>
<span class="c1">## Copyright (C) 2012-2018 RIKEN R-CCS</span>

<span class="sd">&quot;&quot;&quot;Python Binding for KMR Map-Reduce Library.  This provides</span>
<span class="sd">straightforward wrappers to the C routines.  See more about KMR at</span>
<span class="sd">&quot;http://mt.r-ccs.riken.jp/kmr&quot;.  All key-value data is stored in C</span>
<span class="sd">structures after encoding/decoding Python objects to byte arrays in C.</span>
<span class="sd">The documentation in Python is minimum, so please refer to the</span>
<span class="sd">documentation in C.  It works with Python3 (possibly 3.4 and later),</span>
<span class="sd">but not with 2.x.&quot;&quot;&quot;</span>

<span class="c1">## NOTE: Importing MPI module from mpi4py package initializes for MPI</span>
<span class="c1">## execution.  Import MPI and then import kmr4py in application codes.</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">mpi4py</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;20201116&quot;</span>
<span class="n">kmrversion</span> <span class="o">=</span> <span class="s2">&quot;1.10&quot;</span>

<span class="n">kmrso</span> <span class="o">=</span> <span class="kc">None</span>

<span class="sd">&quot;&quot;&quot;kmrso holds a libkmr.so library object.&quot;&quot;&quot;</span>

<span class="n">kmrso_name</span> <span class="o">=</span> <span class="s2">&quot;libkmr.so&quot;</span>

<span class="sd">&quot;&quot;&quot;kmrso_name holds a libkmr.so name, which can be set before calling KMR().&quot;&quot;&quot;</span>

<span class="n">_kmrso_version</span> <span class="o">=</span> <span class="kc">None</span>

<span class="sd">&quot;&quot;&quot;_kmrso_version holds a version taken from a libkmr.so.&quot;&quot;&quot;</span>

<span class="n">_pickle_protocol</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">DEFAULT_PROTOCOL</span>

<span class="n">warning_function</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span>

<span class="sd">&quot;&quot;&quot;warning_function specifies the function used to issue warnings.&quot;&quot;&quot;</span>

<span class="n">ignore_exceptions_in_map_fn</span> <span class="o">=</span> <span class="kc">True</span>

<span class="sd">&quot;&quot;&quot;ignore_exceptions_in_map_fn=True makes exceptions ignored.&quot;&quot;&quot;</span>

<span class="n">print_backtrace_in_map_fn</span> <span class="o">=</span> <span class="kc">True</span>

<span class="sd">&quot;&quot;&quot;print_backtrace_in_map_fn=True makes backtraces are printed at</span>
<span class="sd">exceptions in mapper/reducer functions.&quot;&quot;&quot;</span>

<span class="n">force_null_terminate_in_cstring</span> <span class="o">=</span> <span class="kc">True</span>

<span class="sd">&quot;&quot;&quot;force_null_terminate_in_cstring specifies to add a null-terminator</span>
<span class="sd">in C strings.  Do not change it while some KVS&#39;es are live.&quot;&quot;&quot;</span>

<span class="n">_c_pointer</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span><span class="p">)</span>
<span class="n">_c_kmr</span> <span class="o">=</span> <span class="n">_c_pointer</span>
<span class="n">_c_kvs</span> <span class="o">=</span> <span class="n">_c_pointer</span>
<span class="n">_c_kvsvec</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>
<span class="n">_c_boxvec</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>
<span class="n">_c_fnp</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>
<span class="n">_c_void_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>
<span class="n">_c_ubyte</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ubyte</span>
<span class="n">_c_bool</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_bool</span>
<span class="n">_c_int</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>
<span class="n">_c_uint</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span>
<span class="n">_c_long</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span>
<span class="n">_c_uint8</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint8</span>
<span class="n">_c_uint32</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint32</span>
<span class="n">_c_uint64</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span>
<span class="n">_c_double</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span>
<span class="n">_c_size_t</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_size_t</span>
<span class="n">_c_string</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span>

<span class="c1">## _c_funcptr is ctypes._FuncPtr, but it is taken indirectly</span>
<span class="c1">## because it is hidden.</span>

<span class="c1">##_c_funcptr = type(kmrso.kmr_init_2)</span>

<span class="c1">## _c_null_pointer_value is a null value for ctypes.</span>

<span class="n">_c_null_pointer_value</span> <span class="o">=</span> <span class="n">_c_pointer</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_c_null_pointer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns true if ctypes pointer is null.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

<span class="c1">## _name_coding is used to pass a string to C routines and back.</span>

<span class="c1">##_name_coding = &quot;utf-8&quot;</span>
<span class="n">_name_coding</span> <span class="o">=</span> <span class="s2">&quot;latin-1&quot;</span>

<span class="k">def</span> <span class="nf">_encode</span><span class="p">(</span><span class="n">us</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">us</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">_name_coding</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_decode</span><span class="p">(</span><span class="n">bs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">bs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">_name_coding</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_Slot</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Discrimination of a field indicated by key_or_value.&quot;&quot;&quot;</span>
    <span class="n">Key</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Value</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">## Loading C routines of libkmr.so.</span>

<span class="k">def</span> <span class="nf">_setup_mpi_constants</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Imports values of some MPI constants.  Calling kmr_mpi_type_size</span>
<span class="sd">    and kmr_mpi_constant_value dose not need MPI be initialized.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">c_type_by_size</span><span class="p">(</span><span class="n">siz</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">siz</span> <span class="o">==</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_uint64</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">_c_uint64</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">siz</span> <span class="o">==</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_uint32</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">_c_uint32</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad type size unknown: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">siz</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">global</span> <span class="n">_c_mpi_comm</span><span class="p">,</span> <span class="n">_c_mpi_info</span>
    <span class="k">global</span> <span class="n">_mpi_comm_world</span><span class="p">,</span> <span class="n">_mpi_comm_self</span><span class="p">,</span> <span class="n">_mpi_info_null</span>

    <span class="n">siz</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mpi_type_size</span><span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="s2">&quot;MPI_Comm&quot;</span><span class="p">))</span>
    <span class="n">_c_mpi_comm</span> <span class="o">=</span> <span class="n">c_type_by_size</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mpi_type_size</span><span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="s2">&quot;MPI_Info&quot;</span><span class="p">))</span>
    <span class="n">_c_mpi_info</span> <span class="o">=</span> <span class="n">c_type_by_size</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
    <span class="n">_mpi_comm_world</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mpi_constant_value</span><span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="s2">&quot;MPI_COMM_WORLD&quot;</span><span class="p">))</span>
    <span class="n">_mpi_comm_self</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mpi_constant_value</span><span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="s2">&quot;MPI_COMM_SELF&quot;</span><span class="p">))</span>
    <span class="n">_mpi_info_null</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mpi_constant_value</span><span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="s2">&quot;MPI_INFO_NULL&quot;</span><span class="p">))</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_load_kmrso</span><span class="p">(</span><span class="n">soname</span> <span class="o">=</span> <span class="s2">&quot;libkmr.so&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads libkmr.so, and initializes some constants depending on the</span>
<span class="sd">    library.&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">kmrso</span><span class="p">,</span> <span class="n">_kmrso_version</span>
    <span class="k">global</span> <span class="n">_c_funcptr</span>
    <span class="k">global</span> <span class="n">_kv_bad</span><span class="p">,</span> <span class="n">_kv_opaque</span><span class="p">,</span> <span class="n">_kv_cstring</span><span class="p">,</span> <span class="n">_kv_integer</span><span class="p">,</span> <span class="n">_kv_float8</span>
    <span class="k">global</span> <span class="n">_field_name_type_map</span><span class="p">,</span> <span class="n">_field_type_name_map</span>
    <span class="k">global</span> <span class="n">_MKMAPFN</span><span class="p">,</span> <span class="n">_MKREDFN</span>

    <span class="c1">## Load &quot;libkmr.so&quot;.</span>

    <span class="n">kmrso</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="n">soname</span><span class="p">)</span>

    <span class="n">_kmrso_version</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">kmrso</span><span class="p">,</span> <span class="s2">&quot;kmr_version&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__version__</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_kmrso_version</span><span class="p">)):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s2">&quot;Version unmatch with libkmr.so;&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot; found=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_kmrso_version</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot; required=&quot;</span> <span class="o">+</span> <span class="n">__version__</span><span class="p">),</span>
                      <span class="ne">RuntimeWarning</span><span class="p">)</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mpi_type_size</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_string</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mpi_type_size</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_size_t</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mpi_constant_value</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_string</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mpi_constant_value</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_uint64</span>

    <span class="n">_setup_mpi_constants</span><span class="p">()</span>

    <span class="n">_c_funcptr</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_init_2</span><span class="p">)</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_init_2</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_init_2</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>

    <span class="c1">## Initializes KMR at this point.</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_init_2</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">## Library dependent constants.</span>

    <span class="n">_kv_bad</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">kmrso</span><span class="p">,</span> <span class="s2">&quot;kmr_kv_field_bad&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">_kv_opaque</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">kmrso</span><span class="p">,</span> <span class="s2">&quot;kmr_kv_field_opaque&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">_kv_cstring</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">kmrso</span><span class="p">,</span> <span class="s2">&quot;kmr_kv_field_cstring&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">_kv_integer</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">kmrso</span><span class="p">,</span> <span class="s2">&quot;kmr_kv_field_integer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">_kv_float8</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">kmrso</span><span class="p">,</span> <span class="s2">&quot;kmr_kv_field_float8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="n">_field_name_type_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;opaque&quot;</span> <span class="p">:</span> <span class="n">_kv_opaque</span><span class="p">,</span> <span class="s2">&quot;cstring&quot;</span> <span class="p">:</span> <span class="n">_kv_cstring</span><span class="p">,</span>
        <span class="s2">&quot;integer&quot;</span> <span class="p">:</span> <span class="n">_kv_integer</span><span class="p">,</span> <span class="s2">&quot;float8&quot;</span> <span class="p">:</span> <span class="n">_kv_float8</span><span class="p">}</span>

    <span class="n">_field_type_name_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">reversed</span><span class="p">,</span> <span class="n">_field_name_type_map</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>

    <span class="c1">## C-callable function factories.</span>

    <span class="n">_MKMAPFN</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CFUNCTYPE</span><span class="p">(</span><span class="n">_c_int</span><span class="p">,</span> <span class="n">_c_kvbox</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span>
                                <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_long</span><span class="p">)</span>
    <span class="n">_MKREDFN</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CFUNCTYPE</span><span class="p">(</span><span class="n">_c_int</span><span class="p">,</span> <span class="n">_c_boxvec</span><span class="p">,</span> <span class="n">_c_long</span><span class="p">,</span>
                                <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">)</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_fin</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_fin</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_int</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_initialize_mpi</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_pointer</span><span class="p">,</span> <span class="n">_c_pointer</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_initialize_mpi</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_int</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_context</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_mpi_comm</span><span class="p">,</span> <span class="n">_c_mpi_info</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_context</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_pointer</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_dummy_context</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_dummy_context</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_pointer</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_free_context</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_free_context</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_set_option_by_strings</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_set_option_by_strings</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_kvs7</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kmr</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_kvs7</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_kvs</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvbox</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv_done</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv_done</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_element_count</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_element_count</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_long</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_local_element_count</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_local_element_count</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_long</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map9</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_bool</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">,</span>
        <span class="n">_c_string</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map9</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_once</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">,</span>
                                   <span class="n">_c_bool</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_once</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_rank_by_rank</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_rank_by_rank</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_for_some</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_for_some</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_int</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms_commands</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">,</span> <span class="n">_c_spawn_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms_commands</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_int</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_via_spawn</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_mpi_info</span><span class="p">,</span> <span class="n">_c_spawn_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_via_spawn</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_processes</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_bool</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_mpi_info</span><span class="p">,</span>
        <span class="n">_c_spawn_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_processes</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce9</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_bool</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">,</span>
        <span class="n">_c_string</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce9</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce_as_one</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce_as_one</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_shuffle</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_shuffle</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_replicate</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_replicate</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_distribute</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_bool</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_distribute</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_concatenate_kvs</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvsvec</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_concatenate_kvs</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reverse</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reverse</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort_locally</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_bool</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort_locally</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reply_to_spawner</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reply_to_spawner</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_send_kvs_to_spawner</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_send_kvs_to_spawner</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_spawner_communicator</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_long</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_spawner_communicator</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_mpi_comm</span><span class="p">)</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_files_reassemble</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kmr</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">,</span> <span class="n">_c_uint64</span><span class="p">,</span> <span class="n">_c_uint64</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_void_p</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_uint64</span><span class="p">)]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_files_reassemble</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_file_by_segments</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kmr</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_void_p</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_uint64</span><span class="p">)]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_file_by_segments</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_save_kvs</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_void_p</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_size_t</span><span class="p">),</span>
        <span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_save_kvs</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_restore_kvs</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_size_t</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_restore_kvs</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_dump_kvs</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_dump_kvs</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_key_type_ff</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_key_type_ff</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_int</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_value_type_ff</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kvs</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_value_type_ff</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_int</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_nprocs</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_nprocs</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_int</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_rank</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_rank</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_int</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_size_t</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stringify_options</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stringify_options</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_string</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stringify_file_options</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_file_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stringify_file_options</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_string</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stringify_spawn_options</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_spawn_option</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stringify_spawn_options</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">_c_string</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_swf</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_kvs</span><span class="p">,</span> <span class="n">_c_void_p</span><span class="p">,</span> <span class="n">_c_spawn_option</span><span class="p">,</span> <span class="n">_c_fnp</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_swf</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_init_swf</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kmr</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_mpi_comm</span><span class="p">),</span> <span class="n">_c_int</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_init_swf</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_detach_swf_workers</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_detach_swf_workers</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stop_swf_workers</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stop_swf_workers</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_finish_swf</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_finish_swf</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_split_swf_lanes</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_c_kmr</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_mpi_comm</span><span class="p">),</span> <span class="n">_c_int</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">_c_string</span><span class="p">),</span> <span class="n">_c_bool</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_split_swf_lanes</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_dump_swf_lanes</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_dump_swf_lanes</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_set_swf_verbosity</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_c_kmr</span><span class="p">]</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_set_swf_verbosity</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#receive_kvs_from_spawned_fn = kmrso.kmr_receive_kvs_from_spawned_fn</span>

    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">_string_of_options</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a print string of options for _c_option,</span>
<span class="sd">    _c_file_option, and _c_spawn_option.&quot;&quot;&quot;</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_fields_</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gap16&quot;</span><span class="p">,</span> <span class="s2">&quot;gap32&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="s2">&quot;=1&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_c_option</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;kmr_option.&quot;&quot;&quot;</span>

    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;nothreading&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;keep_open&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;key_as_rank&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;rank_zero&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;collapse&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;take_ckpt&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gap16&quot;</span><span class="p">,</span> <span class="n">_c_uint</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gap32&quot;</span><span class="p">,</span> <span class="n">_c_uint</span><span class="p">,</span> <span class="mi">32</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enabledlist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_c_option</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">enabledlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">enabledlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">## Sets the options as dictionary passed.</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">]):</span>
                <span class="c1">## &quot;key&quot;, &quot;value&quot;, and &quot;output&quot; are Python binding only.</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">enabledlist</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enabledlist</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad option: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;nothreading&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nothreading</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;inspect&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inspect</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;keep_open&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keep_open</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;key_as_rank&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key_as_rank</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;rank_zero&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rank_zero</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;collapse&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;take_ckpt&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">take_ckpt</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad option: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_string_of_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_c_file_option</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;kmr_file_option.&quot;&quot;&quot;</span>

    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;each_rank&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;subdirectories&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;list_file&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;shuffle_names&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gap16&quot;</span><span class="p">,</span> <span class="n">_c_uint</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gap32&quot;</span><span class="p">,</span> <span class="n">_c_uint</span><span class="p">,</span> <span class="mi">32</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enabledlist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_c_file_option</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">enabledlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">enabledlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">## Sets the options as dictionary passed.</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;key&quot;</span> <span class="ow">or</span> <span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">):</span>
                <span class="c1">## &quot;key&quot; and &quot;output&quot; are Python binding only.</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">enabledlist</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enabledlist</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad option: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;each_rank&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">each_rank</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;subdirectories&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subdirectories</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;list_file&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_file</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;shuffle_names&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_names</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad option: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_string_of_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_c_spawn_option</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;kmr_spawn_option.&quot;&quot;&quot;</span>

    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;separator_space&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;reply_each&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;reply_root&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;no_set_infos&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;take_ckpt&quot;</span><span class="p">,</span> <span class="n">_c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gap16&quot;</span><span class="p">,</span> <span class="n">_c_uint</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gap32&quot;</span><span class="p">,</span> <span class="n">_c_uint</span><span class="p">,</span> <span class="mi">32</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enabledlist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_c_spawn_option</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">enabledlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">enabledlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">## Sets the options as dictionary passed.</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;key&quot;</span> <span class="ow">or</span> <span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">):</span>
                <span class="c1">## &quot;key&quot; and &quot;output&quot; are Python binding only.</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">enabledlist</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enabledlist</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad option: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;separator_space&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">separator_space</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;reply_each&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reply_each</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;reply_root&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reply_root</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;no_set_infos&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_set_infos</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;take_ckpt&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">take_ckpt</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad option: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_string_of_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">_spawn_option_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_k</span> <span class="k">for</span> <span class="p">(</span><span class="n">_k</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_c_spawn_option</span><span class="o">.</span><span class="n">_fields_</span><span class="p">]</span>
<span class="n">_file_option_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_k</span> <span class="k">for</span> <span class="p">(</span><span class="n">_k</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_c_file_option</span><span class="o">.</span><span class="n">_fields_</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">_c_unitsized</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Union</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;kmr_unit_sized {const char *p; long i; double d;}.&quot;&quot;&quot;</span>

    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">_c_string</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">_c_long</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">_c_double</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">_c_kvbox</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;kmr_kv_box {int klen, vlen; kmr_unit_sized k, v;}.&quot;&quot;&quot;</span>

    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;klen&quot;</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;vlen&quot;</span><span class="p">,</span> <span class="n">_c_int</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">_c_unitsized</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">_c_unitsized</span><span class="p">)]</span>

    <span class="c1">## NOTE: Defining __init__ with some arguments makes c-callback</span>
    <span class="c1">## fail to call initializers.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_c_kvbox</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klen</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">vlen</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">klen</span> <span class="o">=</span> <span class="n">klen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vlen</span> <span class="o">=</span> <span class="n">vlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">def</span> <span class="nf">_wrap_mapfn</span><span class="p">(</span><span class="n">pyfn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a closure which calls a given Python map-function on</span>
<span class="sd">    the unmarshalled contents in KVS.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pyfn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pyfn</span><span class="p">,</span> <span class="n">_c_funcptr</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">pyfn</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">applyfn</span><span class="p">(</span><span class="n">cbox</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">carg</span><span class="p">,</span> <span class="n">cindex</span><span class="p">):</span>
            <span class="n">kvi</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="n">ckvi</span><span class="p">)</span>
            <span class="n">kvo</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="n">ckvo</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">kvi</span><span class="o">.</span><span class="n">_decode_content</span><span class="p">(</span><span class="n">cbox</span><span class="o">.</span><span class="n">klen</span><span class="p">,</span> <span class="n">cbox</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">kvi</span><span class="o">.</span><span class="n">_decode_content</span><span class="p">(</span><span class="n">cbox</span><span class="o">.</span><span class="n">vlen</span><span class="p">,</span> <span class="n">cbox</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pyfn</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span> <span class="n">kvi</span><span class="p">,</span> <span class="n">kvo</span><span class="p">,</span> <span class="n">cindex</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">warning_function</span><span class="p">((</span><span class="s2">&quot;Exception in Python callbacks: </span><span class="si">%s</span><span class="s2">&quot;</span>
                                  <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])),</span>
                                 <span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">print_backtrace_in_map_fn</span><span class="p">):</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">ignore_exceptions_in_map_fn</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_MKMAPFN</span><span class="p">(</span><span class="n">applyfn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_wrap_redfn</span><span class="p">(</span><span class="n">pyfn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a closure which calls a given Python reduce-function on</span>
<span class="sd">    the unmarshalled contents in KVS.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pyfn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pyfn</span><span class="p">,</span> <span class="n">_c_funcptr</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">pyfn</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">applyfn</span><span class="p">(</span><span class="n">cboxvec</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">carg</span><span class="p">):</span>
            <span class="n">kvi</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="n">ckvi</span><span class="p">)</span>
            <span class="n">kvo</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="n">ckvo</span><span class="p">)</span>
            <span class="n">kvvec</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">cboxvec</span> <span class="o">+</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_kvbox</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">cbox</span> <span class="o">=</span> <span class="n">_c_kvbox</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">kvi</span><span class="o">.</span><span class="n">_decode_content</span><span class="p">(</span><span class="n">cbox</span><span class="o">.</span><span class="n">klen</span><span class="p">,</span> <span class="n">cbox</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">kvi</span><span class="o">.</span><span class="n">_decode_content</span><span class="p">(</span><span class="n">cbox</span><span class="o">.</span><span class="n">vlen</span><span class="p">,</span> <span class="n">cbox</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
                <span class="n">kvvec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pyfn</span><span class="p">(</span><span class="n">kvvec</span><span class="p">,</span> <span class="n">kvi</span><span class="p">,</span> <span class="n">kvo</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">warning_function</span><span class="p">((</span><span class="s2">&quot;Exception in Python callbacks: </span><span class="si">%s</span><span class="s2">&quot;</span>
                                  <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])),</span>
                                 <span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">print_backtrace_in_map_fn</span><span class="p">):</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">ignore_exceptions_in_map_fn</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_MKREDFN</span><span class="p">(</span><span class="n">applyfn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_options</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">with_keyty_valty</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a triple of the options: a key field type, a value</span>
<span class="sd">    field type, and a flag of needs of output generation.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">with_keyty_valty</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="s2">&quot;key&quot;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">))):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad option: key= or value= not allowed&quot;</span><span class="p">)</span>
    <span class="n">keyty</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">)</span>
    <span class="n">valty</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">)</span>
    <span class="n">mkkvo</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_make_frame_info</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">frame</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">f_code</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">_encode</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">co_filename</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">co_name</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_filter_spawn_options</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a pair of dictionaries, the 1st holds options to spawn,</span>
<span class="sd">    and the 2nd holds the other options.&quot;&quot;&quot;</span>

    <span class="n">sopts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">mopts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="ow">in</span> <span class="n">_spawn_option_list</span><span class="p">):</span>
            <span class="n">sopts</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mopts</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="n">mopts</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">KMR</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;KMR context.&quot;&quot;&quot;</span>

    <span class="c1">## attributes: self._ckmr, self.nprocs, self.rank, self.emptykvs,</span>
    <span class="c1">## self._dismissed.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a KMR context with a given MPI communicator (comm),</span>
<span class="sd">        which is used in succeeding operations.  Info specifies its</span>
<span class="sd">        options by MPI_Info.  Arguments of comm/info are passed as a</span>
<span class="sd">        long integer (assuming either an integer (int) or a pointer in</span>
<span class="sd">        C).  It also accepts an communicator instance of mpi4py.MPI.Comm,</span>
<span class="sd">        a string &quot;dummy&quot; or &quot;world&quot; as a comm argument.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">kmrso</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_load_kmrso</span><span class="p">(</span><span class="n">kmrso_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">))):</span>
            <span class="n">warninfo</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warninfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cinfo</span> <span class="o">=</span> <span class="n">_mpi_info_null</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">))):</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">comm</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">Comm</span><span class="p">)):</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">comm_ptr</span> <span class="o">=</span> <span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">_addressof</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">Comm</span><span class="p">)</span> <span class="o">==</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_uint64</span><span class="p">)):</span>
                <span class="n">MPI_Comm</span> <span class="o">=</span> <span class="n">_c_uint64</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">MPI_Comm</span> <span class="o">=</span> <span class="n">_c_void_p</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">MPI_Comm</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">comm_ptr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">comm</span> <span class="o">==</span> <span class="s2">&quot;dummy&quot;</span><span class="p">):</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">_mpi_comm_self</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">comm</span> <span class="o">==</span> <span class="s2">&quot;world&quot;</span><span class="p">):</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">_mpi_comm_world</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">_mpi_comm_world</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_context</span><span class="p">(</span><span class="n">ccomm</span><span class="p">,</span> <span class="n">cinfo</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="sd">&quot;&quot;&quot;self._ckmr holds the C part of a KMR context.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;kmr_create_context: failed&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dismissed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="sd">&quot;&quot;&quot;self._dismissed=True disables freeing KVS&#39;es (by memory</span>
<span class="sd">        management) which remain unconsumed after dismissing a KMR</span>
<span class="sd">        context.  It is because freeing them causes referencing</span>
<span class="sd">        dangling pointers in C.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emptykvs</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;self.emptykvs holds an empty KVS needed by map_once,</span>
<span class="sd">        map_on_rank_zero, read_files_reassemble, and</span>
<span class="sd">        read_file_by_segments.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_nprocs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;self.nprocs holds an nprocs of MPI.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_rank</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;self.rank holds a rank of MPI.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">warncomm</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">warning_function</span><span class="p">(</span><span class="s2">&quot;MPI comm ignored in KMR() constructor.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">warninfo</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">warning_function</span><span class="p">(</span><span class="s2">&quot;MPI info ignored in KMR() constructor.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dismiss</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dismisses KMR (an alias of dismiss()).&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dismiss</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dismiss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dismisses KMR.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)):</span>
            <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_free_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span> <span class="o">=</span> <span class="n">_c_null_pointer_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dismissed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emptykvs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">create_kvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a new KVS (an alias of make_kvs()).&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_kvs</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_kvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a new KVS.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reply_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends a reply message from a spawned process.&quot;&quot;&quot;</span>

        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reply_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_spawner_communicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtains a parent communicator of a spawned process.  C version</span>
<span class="sd">        returns a reference, but this returns an entity&quot;&quot;&quot;</span>

        <span class="n">commref</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_spawner_communicator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">commref</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">send_kvs_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kvs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends the KVS from a spawned process to the spawner.&quot;&quot;&quot;</span>

        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_send_kvs_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">kvs</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_init_swf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splitcomms</span><span class="p">,</span> <span class="n">masterank</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_init_swf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">splitcomms</span><span class="p">,</span> <span class="n">masterank</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_detach_swf_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_detach_swf_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_stop_swf_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stop_swf_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_finish_swf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_finish_swf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_split_swf_lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masterrank</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">dump</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">comms</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_mpi_comm</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)()</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))()</span>
        <span class="n">desc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
        <span class="n">desc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_split_swf_lanes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">comms</span><span class="p">,</span> <span class="n">masterrank</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">comms</span>

    <span class="k">def</span> <span class="nf">_dump_swf_lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_dump_swf_lanes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_set_swf_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_set_swf_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">set_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets KMR option, taking both arguments by strings.&quot;&quot;&quot;</span>

        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_set_option_by_strings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_encode</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">return</span>

<span class="n">_enabled_options_of_map</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;nothreading&quot;</span><span class="p">,</span> <span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="s2">&quot;keep_open&quot;</span><span class="p">,</span> <span class="s2">&quot;take_ckpt&quot;</span><span class="p">]</span>

<span class="n">_enabled_options_of_map_once</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;nothreading&quot;</span><span class="p">,</span> <span class="s2">&quot;keep_open&quot;</span><span class="p">,</span> <span class="s2">&quot;take_ckpt&quot;</span><span class="p">]</span>

<span class="n">_enabled_options_of_map_ms</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;nothreading&quot;</span><span class="p">,</span> <span class="s2">&quot;keep_open&quot;</span><span class="p">]</span>

<span class="n">_enabled_options_of_reduce</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;nothreading&quot;</span><span class="p">,</span> <span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="s2">&quot;take_ckpt&quot;</span><span class="p">]</span>

<span class="n">_enabled_options_of_reduce_as_one</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="s2">&quot;take_ckpt&quot;</span><span class="p">]</span>

<span class="n">_enabled_options_of_shuffle</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="s2">&quot;key_as_rank&quot;</span><span class="p">,</span> <span class="s2">&quot;take_ckpt&quot;</span><span class="p">]</span>

<span class="n">_enabled_options_of_replicate</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="s2">&quot;rank_zero&quot;</span><span class="p">,</span> <span class="s2">&quot;take_ckpt&quot;</span><span class="p">]</span>

<span class="n">_enabled_options_of_distribute</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;nothreading&quot;</span><span class="p">,</span> <span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="s2">&quot;keep_open&quot;</span><span class="p">]</span>

<span class="n">_enabled_options_of_sort_locally</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;nothreading&quot;</span><span class="p">,</span> <span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="s2">&quot;key_as_rank&quot;</span><span class="p">]</span>

<span class="n">_enabled_options_of_sort</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;inspect&quot;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">KVS</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;KVS.  Note that there are dummy KVS&#39;es which are temporarily</span>
<span class="sd">    created to hold the C structure of the KVS passed to</span>
<span class="sd">    mapper/reducer functions.  A dummy KVS has None in its &quot;mr&quot;</span>
<span class="sd">    attribute.&quot;&quot;&quot;</span>

    <span class="c1"># attributes: self._ckvs, self.mr, self._frameinfo.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kmr_or_ckvs</span><span class="p">,</span> <span class="n">keyty</span><span class="o">=</span><span class="s2">&quot;opaque&quot;</span><span class="p">,</span> <span class="n">valty</span><span class="o">=</span><span class="s2">&quot;opaque&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a KVS for a given KMR.  Do not call the KVS constructor</span>
<span class="sd">        directly, but use KMR.make_kvs() instead.  A KVS is created</span>
<span class="sd">        with the datatypes stored in the key and the value, specified</span>
<span class="sd">        by the keywords &quot;key=&quot; and &quot;value=&quot;.  The datatype name is a</span>
<span class="sd">        string, one of &quot;opaque&quot;, &quot;cstring&quot;, &quot;integer&quot;, and &quot;float8&quot;.</span>
<span class="sd">        Most mappers and reducers (precisely, the methods that accepts</span>
<span class="sd">        a function argument) take keyword arguments for the types,</span>
<span class="sd">        defaulting with key=&quot;opaque&quot; and value=&quot;opaque&quot;.  The</span>
<span class="sd">        datatypes affects the sorting order.  &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="sd">&quot;&quot;&quot;mr attribute holds a KMR context object.  Note that mr is</span>
<span class="sd">        not accessible from mapping/reducing functions.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="sd">&quot;&quot;&quot;_ckvs attribute holds a kvs in C.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_frameinfo</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="sd">&quot;&quot;&quot;_frameinfo protects caller line information from garbage</span>
<span class="sd">        collected.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kmr_or_ckvs</span><span class="p">,</span> <span class="n">KMR</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">_field_name_type_map</span><span class="p">[</span><span class="n">keyty</span><span class="p">]</span>
            <span class="n">vf</span> <span class="o">=</span> <span class="n">_field_name_type_map</span><span class="p">[</span><span class="n">valty</span><span class="p">]</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="n">kmr_or_ckvs</span>
            <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_kvs7</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">(),</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frameinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kmr_or_ckvs</span><span class="p">,</span> <span class="n">_c_pointer</span><span class="p">):</span>
            <span class="c1">## Return a dummy KVS.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">kmr_or_ckvs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad call to kvs constructor&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dummy</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes the C part of a KVS.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_dummy</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad call to free_kvs on dummy KVS&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad call to free_kvs on freed KVS&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_dismissed</span><span class="p">):</span>
            <span class="c1">## Do not free when KMR object is dismissed.</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_free_kvs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">_c_null_pointer_value</span>
            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_is_dummy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_consume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Releases a now dangling C pointer.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">_c_null_pointer_value</span>

    <span class="k">def</span> <span class="nf">_encode_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">key_or_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Marshalls an object with regard to the field type.  It</span>
<span class="sd">        retuns a 3-tuple, with length, value-union, and the 3nd to</span>
<span class="sd">        keep a reference to a buffer.&quot;&quot;&quot;</span>

        <span class="n">kvty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">key_or_value</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">_c_unitsized</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;opaque&quot;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">_pickle_protocol</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">u</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;cstring&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not 8-bit string for cstring: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="p">)</span>
            <span class="c1">## (Add null for C string).</span>
            <span class="n">os</span> <span class="o">=</span> <span class="p">((</span><span class="n">o</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">force_null_terminate_in_cstring</span> <span class="k">else</span> <span class="n">o</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_encode</span><span class="p">(</span><span class="n">os</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">u</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">):</span>
            <span class="n">u</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">o</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_long</span><span class="p">),</span> <span class="n">u</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;float8&quot;</span><span class="p">):</span>
            <span class="n">u</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">o</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_double</span><span class="p">),</span> <span class="n">u</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kvty</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_decode_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">siz</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">key_or_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unmarshalls an object with regard to the field type.  It</span>
<span class="sd">        returns integer 0 when the length is 0 (it is for a dummy</span>
<span class="sd">        key-value used in kmr_map_once() etc).&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">siz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kvty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">key_or_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;opaque&quot;</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">string_at</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">siz</span><span class="p">)</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">o</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;cstring&quot;</span><span class="p">):</span>
                <span class="c1">## (Delete null added for C string).</span>
                <span class="n">siz1</span> <span class="o">=</span> <span class="p">((</span><span class="n">siz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">force_null_terminate_in_cstring</span> <span class="k">else</span> <span class="n">siz</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">string_at</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">siz1</span><span class="p">)</span>
                <span class="n">os</span> <span class="o">=</span> <span class="n">_decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">os</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">i</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;float8&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kvty</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_field_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_or_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a field type of a KVS.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad KVS (null C-object)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key_or_value</span> <span class="o">==</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
            <span class="n">kvty</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_key_type_ff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">key_or_value</span> <span class="o">==</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">):</span>
            <span class="n">kvty</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_value_type_ff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key_or_value</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="n">_kv_bad</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field type value </span><span class="si">%d</span><span class="s2"> in KVS&quot;</span> <span class="o">%</span> <span class="n">kvty</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_field_type_name_map</span><span class="p">[</span><span class="n">kvty</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a key-value pair.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_kv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">add_kv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a key-value pair.&quot;&quot;&quot;</span>

        <span class="c1">## Note it keeps the created string until kmr_add_kv(),</span>
        <span class="c1">## because kvbox does not hold the references.</span>
        <span class="p">(</span><span class="n">klen</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ks</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_content</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="p">(</span><span class="n">vlen</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_content</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="n">cbox</span> <span class="o">=</span> <span class="n">_c_kvbox</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">klen</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">vlen</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">cbox</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">add_kv_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes adding key-value pairs.&quot;&quot;&quot;</span>

        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv_done</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_element_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the total number of key-value pairs.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">_c_long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_element_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">local_element_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the number of key-value pairs locally.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">_c_long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_local_element_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps simply.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map9</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank_zero_only</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps once with a dummy key-value pair.&quot;&quot;&quot;</span>

        <span class="c1">## It needs dummy input; Never inspects.</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map_once</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_once</span><span class="p">(</span><span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">rank_zero_only</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_on_rank_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on rank0 only.&quot;&quot;&quot;</span>

        <span class="c1">## It needs dummy input.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_once</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">mopts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">map_rank_by_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps sequentially with rank by rank for debugging.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_rank_by_rank</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_for_some</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps until some key-value are added.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_for_some</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_ms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps in master-worker mode.&quot;&quot;&quot;</span>

        <span class="c1">## Its call is repeated until True (assuming MPI_SUCCESS==0).</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map_ms</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_ms_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">xopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps in master-worker mode, and runs serial commands.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="n">mopts</span><span class="p">)</span> <span class="o">=</span> <span class="n">_filter_spawn_options</span><span class="p">(</span><span class="n">xopts</span><span class="p">)</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map_ms</span><span class="p">)</span>
        <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms_commands</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_via_spawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">xopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="n">mopts</span><span class="p">)</span> <span class="o">=</span> <span class="n">_filter_spawn_options</span><span class="p">(</span><span class="n">xopts</span><span class="p">)</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_via_spawn</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_mpi_info_null</span><span class="p">,</span> <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonmpi</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_processes</span><span class="p">(</span><span class="n">nonmpi</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_mpi_info_null</span><span class="p">,</span>
                                <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_parallel_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_processes</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">map_serial_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_processes</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reduces key-value pairs.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_reduce</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_redfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce9</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">reduce_as_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reduces once as if all pairs had the same key.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_reduce_as_one</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_redfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce_as_one</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">reduce_for_some</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reduces until some key-value are added.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_reduce</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_redfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1">## (NOTE: It passes a frame of reduce_for_some.)</span>
        <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">())</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce9</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a new pair by swapping the key and the value.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">mkkvo</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">keyty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reverse</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shuffles key-value pairs.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_shuffle</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_shuffle</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">replicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replicates key-value pairs to be visible on all ranks.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_replicate</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_replicate</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">distribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Distributes pairs approximately evenly to ranks.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_distribute</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_distribute</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">sort_locally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shuffling</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reorders key-value pairs in a single rank.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_sort_locally</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort_locally</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">shuffling</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sorts a KVS globally.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_sort</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">morekvs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Concatenates a number of KVS&#39;es to one.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">morekvs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ckvsvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_kvs</span> <span class="o">*</span> <span class="n">siz</span><span class="p">)()</span>
        <span class="n">ckvsvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">morekvs</span><span class="p">)):</span>
            <span class="n">ckvsvec</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">morekvs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">_c_int</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_concatenate_kvs</span><span class="p">(</span><span class="n">ckvsvec</span><span class="p">,</span> <span class="n">cn</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">morekvs</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">read_files_reassemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reassembles files reading by ranks.&quot;&quot;&quot;</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">_c_void_p</span><span class="p">()</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="n">_c_uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_files_reassemble</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes_</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">siz</span><span class="p">))</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">read_file_by_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads one file by segments and reassembles.&quot;&quot;&quot;</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">_c_void_p</span><span class="p">()</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="n">_c_uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_file_by_segments</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">siz</span><span class="p">))</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Packs locally the contents of a KVS to a byte array.&quot;&quot;&quot;</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">_c_void_p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="n">_c_size_t</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_save_kvs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">siz</span><span class="p">),</span>
                           <span class="n">_c_option</span><span class="p">())</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unpacks locally the contents of a KVS from a byte array.&quot;&quot;&quot;</span>

        <span class="n">kvo</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">)</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="p">)</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_restore_kvs</span><span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">_map_swf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">xopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="n">mopts</span><span class="p">)</span> <span class="o">=</span> <span class="n">_filter_spawn_options</span><span class="p">(</span><span class="n">xopts</span><span class="p">)</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_swf</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

<span class="k">def</span> <span class="nf">fin</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Finishes using KMR4PY.&quot;&quot;&quot;</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_fin</span><span class="p">()</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">listify</span><span class="p">(</span><span class="n">kvs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an array of LOCAL contents.&quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">kvs</span><span class="o">.</span><span class="n">local_element_count</span><span class="p">()</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">f</span> <span class="p">(</span><span class="n">kv</span><span class="p">,</span> <span class="n">kvi</span><span class="p">,</span> <span class="n">kvo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">_data</span><span class="p">):</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kv</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="n">kvs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inspect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="k">def</span> <span class="nf">_stringify_options</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_decode</span><span class="p">(</span><span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stringify_options</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_stringify_file_options</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_decode</span><span class="p">(</span><span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stringify_file_options</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_stringify_spawn_options</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_decode</span><span class="p">(</span><span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stringify_spawn_options</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_check_ctypes_values</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Checks if ctypes values are properly used.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_c_null_pointer</span><span class="p">(</span><span class="n">_c_null_pointer_value</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;BAD: C null pointer has a wrong value.&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_check_passing_options</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Checks if the options are passed properly from Python to C.&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">stringify</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">_c_option</span><span class="p">,</span> <span class="n">_stringify_options</span><span class="p">),</span>
            <span class="p">(</span><span class="n">_c_file_option</span><span class="p">,</span> <span class="n">_stringify_file_options</span><span class="p">),</span>
            <span class="p">(</span><span class="n">_c_spawn_option</span><span class="p">,</span> <span class="n">_stringify_spawn_options</span><span class="p">)]:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">option</span><span class="o">.</span><span class="n">_fields_</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;gap16&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="s2">&quot;gap32&quot;</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">copts</span> <span class="o">=</span> <span class="n">option</span><span class="p">({</span><span class="n">o</span> <span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">stringify</span><span class="p">(</span><span class="n">copts</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">!=</span> <span class="n">s</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;BAD: </span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="c1">## Document generator &quot;pdoc&quot; requires loading kmr4py.py without</span>
<span class="c1">## initializing MPI.</span>
<span class="c1">##if (sys.modules[&quot;mpi4py&quot;].__name__ != &quot;dummy_mpi4py&quot;):</span>
<span class="c1">##    _load_kmrso(kmrso_name)</span>

<span class="c1"># Copyright (C) 2012-2018 RIKEN R-CCS</span>
<span class="c1"># This library is distributed WITHOUT ANY WARRANTY.  This library can be</span>
<span class="c1"># redistributed and/or modified under the terms of the BSD 2-Clause License.</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="kmr4py.force_null_terminate_in_cstring" class="name">var <span class="ident">force_null_terminate_in_cstring</span></p>
      
  
    <div class="desc"><p>force_null_terminate_in_cstring specifies to add a null-terminator
in C strings.  Do not change it while some KVS'es are live.</p></div>
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="kmr4py.ignore_exceptions_in_map_fn" class="name">var <span class="ident">ignore_exceptions_in_map_fn</span></p>
      
  
    <div class="desc"><p>ignore_exceptions_in_map_fn=True makes exceptions ignored.</p></div>
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="kmr4py.kmrso" class="name">var <span class="ident">kmrso</span></p>
      
  
    <div class="desc"><p>kmrso holds a libkmr.so library object.</p></div>
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="kmr4py.kmrso_name" class="name">var <span class="ident">kmrso_name</span></p>
      
  
    <div class="desc"><p>kmrso_name holds a libkmr.so name, which can be set before calling KMR().</p></div>
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="kmr4py.kmrversion" class="name">var <span class="ident">kmrversion</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="kmr4py.print_backtrace_in_map_fn" class="name">var <span class="ident">print_backtrace_in_map_fn</span></p>
      
  
    <div class="desc"><p>print_backtrace_in_map_fn=True makes backtraces are printed at
exceptions in mapper/reducer functions.</p></div>
  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="kmr4py.fin">
    <p>def <span class="ident">fin</span>(</p><p>)</p>
    </div>
    

    
  
    <div class="desc"><p>Finishes using KMR4PY.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.fin', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.fin" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">fin</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Finishes using KMR4PY.&quot;&quot;&quot;</span>

    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_fin</span><span class="p">()</span>
    <span class="k">return</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="kmr4py.listify">
    <p>def <span class="ident">listify</span>(</p><p>kvs)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns an array of LOCAL contents.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.listify', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.listify" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">listify</span><span class="p">(</span><span class="n">kvs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an array of LOCAL contents.&quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">kvs</span><span class="o">.</span><span class="n">local_element_count</span><span class="p">()</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">f</span> <span class="p">(</span><span class="n">kv</span><span class="p">,</span> <span class="n">kvi</span><span class="p">,</span> <span class="n">kvo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">_data</span><span class="p">):</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kv</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="n">kvs</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inspect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="kmr4py.warning_function">
    <p>def <span class="ident">warning_function</span>(</p><p>...)</p>
    </div>
    

    
  
    <div class="desc"><p>Issue a warning, or maybe ignore it or raise an exception.</p></div>
  <div class="source_cont">
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="kmr4py.KMR" class="name">class <span class="ident">KMR</span></p>
      
  
    <div class="desc"><p>KMR context.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">KMR</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;KMR context.&quot;&quot;&quot;</span>

    <span class="c1">## attributes: self._ckmr, self.nprocs, self.rank, self.emptykvs,</span>
    <span class="c1">## self._dismissed.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a KMR context with a given MPI communicator (comm),</span>
<span class="sd">        which is used in succeeding operations.  Info specifies its</span>
<span class="sd">        options by MPI_Info.  Arguments of comm/info are passed as a</span>
<span class="sd">        long integer (assuming either an integer (int) or a pointer in</span>
<span class="sd">        C).  It also accepts an communicator instance of mpi4py.MPI.Comm,</span>
<span class="sd">        a string &quot;dummy&quot; or &quot;world&quot; as a comm argument.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">kmrso</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_load_kmrso</span><span class="p">(</span><span class="n">kmrso_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">))):</span>
            <span class="n">warninfo</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warninfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cinfo</span> <span class="o">=</span> <span class="n">_mpi_info_null</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">))):</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">comm</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">Comm</span><span class="p">)):</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">comm_ptr</span> <span class="o">=</span> <span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">_addressof</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">Comm</span><span class="p">)</span> <span class="o">==</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_uint64</span><span class="p">)):</span>
                <span class="n">MPI_Comm</span> <span class="o">=</span> <span class="n">_c_uint64</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">MPI_Comm</span> <span class="o">=</span> <span class="n">_c_void_p</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">MPI_Comm</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">comm_ptr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">comm</span> <span class="o">==</span> <span class="s2">&quot;dummy&quot;</span><span class="p">):</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">_mpi_comm_self</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">comm</span> <span class="o">==</span> <span class="s2">&quot;world&quot;</span><span class="p">):</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">_mpi_comm_world</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ccomm</span> <span class="o">=</span> <span class="n">_mpi_comm_world</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_context</span><span class="p">(</span><span class="n">ccomm</span><span class="p">,</span> <span class="n">cinfo</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="sd">&quot;&quot;&quot;self._ckmr holds the C part of a KMR context.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;kmr_create_context: failed&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dismissed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="sd">&quot;&quot;&quot;self._dismissed=True disables freeing KVS&#39;es (by memory</span>
<span class="sd">        management) which remain unconsumed after dismissing a KMR</span>
<span class="sd">        context.  It is because freeing them causes referencing</span>
<span class="sd">        dangling pointers in C.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emptykvs</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>

        <span class="sd">&quot;&quot;&quot;self.emptykvs holds an empty KVS needed by map_once,</span>
<span class="sd">        map_on_rank_zero, read_files_reassemble, and</span>
<span class="sd">        read_file_by_segments.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_nprocs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;self.nprocs holds an nprocs of MPI.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_rank</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;self.rank holds a rank of MPI.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">warncomm</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">warning_function</span><span class="p">(</span><span class="s2">&quot;MPI comm ignored in KMR() constructor.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">warninfo</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">warning_function</span><span class="p">(</span><span class="s2">&quot;MPI info ignored in KMR() constructor.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dismiss</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dismisses KMR (an alias of dismiss()).&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dismiss</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dismiss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dismisses KMR.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)):</span>
            <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_free_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span> <span class="o">=</span> <span class="n">_c_null_pointer_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dismissed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emptykvs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">create_kvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a new KVS (an alias of make_kvs()).&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_kvs</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_kvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a new KVS.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reply_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends a reply message from a spawned process.&quot;&quot;&quot;</span>

        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reply_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_spawner_communicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtains a parent communicator of a spawned process.  C version</span>
<span class="sd">        returns a reference, but this returns an entity&quot;&quot;&quot;</span>

        <span class="n">commref</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_spawner_communicator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">commref</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">send_kvs_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kvs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends the KVS from a spawned process to the spawner.&quot;&quot;&quot;</span>

        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_send_kvs_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">kvs</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_init_swf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splitcomms</span><span class="p">,</span> <span class="n">masterank</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_init_swf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">splitcomms</span><span class="p">,</span> <span class="n">masterank</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_detach_swf_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_detach_swf_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_stop_swf_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_stop_swf_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_finish_swf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_finish_swf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_split_swf_lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masterrank</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">dump</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">comms</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_mpi_comm</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)()</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))()</span>
        <span class="n">desc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
        <span class="n">desc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_split_swf_lanes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">comms</span><span class="p">,</span> <span class="n">masterrank</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">dump</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">comms</span>

    <span class="k">def</span> <span class="nf">_dump_swf_lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_dump_swf_lanes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_set_swf_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_set_swf_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">set_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets KMR option, taking both arguments by strings.&quot;&quot;&quot;</span>

        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_set_option_by_strings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_encode</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">return</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#kmr4py.KMR">KMR</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="kmr4py.KMR.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, comm, info=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Makes a KMR context with a given MPI communicator (comm),
which is used in succeeding operations.  Info specifies its
options by MPI_Info.  Arguments of comm/info are passed as a
long integer (assuming either an integer (int) or a pointer in
C).  It also accepts an communicator instance of mpi4py.MPI.Comm,
a string "dummy" or "world" as a comm argument.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR.__init__', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a KMR context with a given MPI communicator (comm),</span>
<span class="sd">    which is used in succeeding operations.  Info specifies its</span>
<span class="sd">    options by MPI_Info.  Arguments of comm/info are passed as a</span>
<span class="sd">    long integer (assuming either an integer (int) or a pointer in</span>
<span class="sd">    C).  It also accepts an communicator instance of mpi4py.MPI.Comm,</span>
<span class="sd">    a string &quot;dummy&quot; or &quot;world&quot; as a comm argument.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kmrso</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">_load_kmrso</span><span class="p">(</span><span class="n">kmrso_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">))):</span>
        <span class="n">warninfo</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warninfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">cinfo</span> <span class="o">=</span> <span class="n">_mpi_info_null</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">))):</span>
        <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ccomm</span> <span class="o">=</span> <span class="n">comm</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">Comm</span><span class="p">)):</span>
        <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">comm_ptr</span> <span class="o">=</span> <span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">_addressof</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">Comm</span><span class="p">)</span> <span class="o">==</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_uint64</span><span class="p">)):</span>
            <span class="n">MPI_Comm</span> <span class="o">=</span> <span class="n">_c_uint64</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">MPI_Comm</span> <span class="o">=</span> <span class="n">_c_void_p</span>
        <span class="n">ccomm</span> <span class="o">=</span> <span class="n">MPI_Comm</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">comm_ptr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">comm</span> <span class="o">==</span> <span class="s2">&quot;dummy&quot;</span><span class="p">):</span>
        <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ccomm</span> <span class="o">=</span> <span class="n">_mpi_comm_self</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">comm</span> <span class="o">==</span> <span class="s2">&quot;world&quot;</span><span class="p">):</span>
        <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ccomm</span> <span class="o">=</span> <span class="n">_mpi_comm_world</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warncomm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ccomm</span> <span class="o">=</span> <span class="n">_mpi_comm_world</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_context</span><span class="p">(</span><span class="n">ccomm</span><span class="p">,</span> <span class="n">cinfo</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="sd">&quot;&quot;&quot;self._ckmr holds the C part of a KMR context.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;kmr_create_context: failed&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dismissed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;self._dismissed=True disables freeing KVS&#39;es (by memory</span>
<span class="sd">    management) which remain unconsumed after dismissing a KMR</span>
<span class="sd">    context.  It is because freeing them causes referencing</span>
<span class="sd">    dangling pointers in C.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">emptykvs</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;self.emptykvs holds an empty KVS needed by map_once,</span>
<span class="sd">    map_on_rank_zero, read_files_reassemble, and</span>
<span class="sd">    read_file_by_segments.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_nprocs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;self.nprocs holds an nprocs of MPI.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_rank</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;self.rank holds a rank of MPI.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">warncomm</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="n">warning_function</span><span class="p">(</span><span class="s2">&quot;MPI comm ignored in KMR() constructor.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">warninfo</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="n">warning_function</span><span class="p">(</span><span class="s2">&quot;MPI info ignored in KMR() constructor.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KMR.create_kvs">
    <p>def <span class="ident">create_kvs</span>(</p><p>self, **opts)</p>
    </div>
    

    
  
    <div class="desc"><p>Makes a new KVS (an alias of make_kvs()).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR.create_kvs', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR.create_kvs" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_kvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a new KVS (an alias of make_kvs()).&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">make_kvs</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KMR.dismiss">
    <p>def <span class="ident">dismiss</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Dismisses KMR.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR.dismiss', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR.dismiss" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dismiss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dismisses KMR.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)):</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_free_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span> <span class="o">=</span> <span class="n">_c_null_pointer_value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dismissed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">emptykvs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KMR.free">
    <p>def <span class="ident">free</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Dismisses KMR (an alias of dismiss()).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR.free', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR.free" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dismisses KMR (an alias of dismiss()).&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dismiss</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KMR.get_spawner_communicator">
    <p>def <span class="ident">get_spawner_communicator</span>(</p><p>self, index)</p>
    </div>
    

    
  
    <div class="desc"><p>Obtains a parent communicator of a spawned process.  C version
returns a reference, but this returns an entity</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR.get_spawner_communicator', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR.get_spawner_communicator" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_spawner_communicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Obtains a parent communicator of a spawned process.  C version</span>
<span class="sd">    returns a reference, but this returns an entity&quot;&quot;&quot;</span>
    <span class="n">commref</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_spawner_communicator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">commref</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">value</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KMR.make_kvs">
    <p>def <span class="ident">make_kvs</span>(</p><p>self, **opts)</p>
    </div>
    

    
  
    <div class="desc"><p>Makes a new KVS.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR.make_kvs', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR.make_kvs" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">make_kvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a new KVS.&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KMR.reply_to_spawner">
    <p>def <span class="ident">reply_to_spawner</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Sends a reply message from a spawned process.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR.reply_to_spawner', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR.reply_to_spawner" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">reply_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends a reply message from a spawned process.&quot;&quot;&quot;</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reply_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KMR.send_kvs_to_spawner">
    <p>def <span class="ident">send_kvs_to_spawner</span>(</p><p>self, kvs)</p>
    </div>
    

    
  
    <div class="desc"><p>Sends the KVS from a spawned process to the spawner.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR.send_kvs_to_spawner', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR.send_kvs_to_spawner" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">send_kvs_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kvs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends the KVS from a spawned process to the spawner.&quot;&quot;&quot;</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_send_kvs_to_spawner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">kvs</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KMR.set_option">
    <p>def <span class="ident">set_option</span>(</p><p>self, k, v)</p>
    </div>
    

    
  
    <div class="desc"><p>Sets KMR option, taking both arguments by strings.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KMR.set_option', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KMR.set_option" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">set_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets KMR option, taking both arguments by strings.&quot;&quot;&quot;</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_set_option_by_strings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_encode</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>

  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="kmr4py.KMR.emptykvs" class="name">var <span class="ident">emptykvs</span></p>
            

            
  
    <div class="desc"><p>self.emptykvs holds an empty KVS needed by map_once,
map_on_rank_zero, read_files_reassemble, and
read_file_by_segments.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="kmr4py.KMR.nprocs" class="name">var <span class="ident">nprocs</span></p>
            

            
  
    <div class="desc"><p>self.nprocs holds an nprocs of MPI.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="kmr4py.KMR.rank" class="name">var <span class="ident">rank</span></p>
            

            
  
    <div class="desc"><p>self.rank holds a rank of MPI.</p></div>
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>
      
      <div class="item">
      <p id="kmr4py.KVS" class="name">class <span class="ident">KVS</span></p>
      
  
    <div class="desc"><p>KVS.  Note that there are dummy KVS'es which are temporarily
created to hold the C structure of the KVS passed to
mapper/reducer functions.  A dummy KVS has None in its "mr"
attribute.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">KVS</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;KVS.  Note that there are dummy KVS&#39;es which are temporarily</span>
<span class="sd">    created to hold the C structure of the KVS passed to</span>
<span class="sd">    mapper/reducer functions.  A dummy KVS has None in its &quot;mr&quot;</span>
<span class="sd">    attribute.&quot;&quot;&quot;</span>

    <span class="c1"># attributes: self._ckvs, self.mr, self._frameinfo.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kmr_or_ckvs</span><span class="p">,</span> <span class="n">keyty</span><span class="o">=</span><span class="s2">&quot;opaque&quot;</span><span class="p">,</span> <span class="n">valty</span><span class="o">=</span><span class="s2">&quot;opaque&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a KVS for a given KMR.  Do not call the KVS constructor</span>
<span class="sd">        directly, but use KMR.make_kvs() instead.  A KVS is created</span>
<span class="sd">        with the datatypes stored in the key and the value, specified</span>
<span class="sd">        by the keywords &quot;key=&quot; and &quot;value=&quot;.  The datatype name is a</span>
<span class="sd">        string, one of &quot;opaque&quot;, &quot;cstring&quot;, &quot;integer&quot;, and &quot;float8&quot;.</span>
<span class="sd">        Most mappers and reducers (precisely, the methods that accepts</span>
<span class="sd">        a function argument) take keyword arguments for the types,</span>
<span class="sd">        defaulting with key=&quot;opaque&quot; and value=&quot;opaque&quot;.  The</span>
<span class="sd">        datatypes affects the sorting order.  &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="sd">&quot;&quot;&quot;mr attribute holds a KMR context object.  Note that mr is</span>
<span class="sd">        not accessible from mapping/reducing functions.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="sd">&quot;&quot;&quot;_ckvs attribute holds a kvs in C.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_frameinfo</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="sd">&quot;&quot;&quot;_frameinfo protects caller line information from garbage</span>
<span class="sd">        collected.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kmr_or_ckvs</span><span class="p">,</span> <span class="n">KMR</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="n">_field_name_type_map</span><span class="p">[</span><span class="n">keyty</span><span class="p">]</span>
            <span class="n">vf</span> <span class="o">=</span> <span class="n">_field_name_type_map</span><span class="p">[</span><span class="n">valty</span><span class="p">]</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="n">kmr_or_ckvs</span>
            <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_kvs7</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">(),</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frameinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kmr_or_ckvs</span><span class="p">,</span> <span class="n">_c_pointer</span><span class="p">):</span>
            <span class="c1">## Return a dummy KVS.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">kmr_or_ckvs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad call to kvs constructor&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dummy</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes the C part of a KVS.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_dummy</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad call to free_kvs on dummy KVS&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad call to free_kvs on freed KVS&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_dismissed</span><span class="p">):</span>
            <span class="c1">## Do not free when KMR object is dismissed.</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_free_kvs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">_c_null_pointer_value</span>
            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_is_dummy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_consume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Releases a now dangling C pointer.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">_c_null_pointer_value</span>

    <span class="k">def</span> <span class="nf">_encode_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">key_or_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Marshalls an object with regard to the field type.  It</span>
<span class="sd">        retuns a 3-tuple, with length, value-union, and the 3nd to</span>
<span class="sd">        keep a reference to a buffer.&quot;&quot;&quot;</span>

        <span class="n">kvty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">key_or_value</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">_c_unitsized</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;opaque&quot;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">_pickle_protocol</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">u</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;cstring&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not 8-bit string for cstring: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">o</span><span class="p">)</span>
            <span class="c1">## (Add null for C string).</span>
            <span class="n">os</span> <span class="o">=</span> <span class="p">((</span><span class="n">o</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">force_null_terminate_in_cstring</span> <span class="k">else</span> <span class="n">o</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_encode</span><span class="p">(</span><span class="n">os</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">u</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">):</span>
            <span class="n">u</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">o</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_long</span><span class="p">),</span> <span class="n">u</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;float8&quot;</span><span class="p">):</span>
            <span class="n">u</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">o</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">_c_double</span><span class="p">),</span> <span class="n">u</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kvty</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_decode_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">siz</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">key_or_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unmarshalls an object with regard to the field type.  It</span>
<span class="sd">        returns integer 0 when the length is 0 (it is for a dummy</span>
<span class="sd">        key-value used in kmr_map_once() etc).&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">siz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kvty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">key_or_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;opaque&quot;</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">string_at</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">siz</span><span class="p">)</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">o</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;cstring&quot;</span><span class="p">):</span>
                <span class="c1">## (Delete null added for C string).</span>
                <span class="n">siz1</span> <span class="o">=</span> <span class="p">((</span><span class="n">siz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">force_null_terminate_in_cstring</span> <span class="k">else</span> <span class="n">siz</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">string_at</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">siz1</span><span class="p">)</span>
                <span class="n">os</span> <span class="o">=</span> <span class="n">_decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">os</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">i</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="s2">&quot;float8&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kvty</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_field_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_or_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a field type of a KVS.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad KVS (null C-object)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key_or_value</span> <span class="o">==</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
            <span class="n">kvty</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_key_type_ff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">key_or_value</span> <span class="o">==</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">):</span>
            <span class="n">kvty</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_value_type_ff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key_or_value</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="n">_kv_bad</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field type value </span><span class="si">%d</span><span class="s2"> in KVS&quot;</span> <span class="o">%</span> <span class="n">kvty</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_field_type_name_map</span><span class="p">[</span><span class="n">kvty</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a key-value pair.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_kv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">add_kv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a key-value pair.&quot;&quot;&quot;</span>

        <span class="c1">## Note it keeps the created string until kmr_add_kv(),</span>
        <span class="c1">## because kvbox does not hold the references.</span>
        <span class="p">(</span><span class="n">klen</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ks</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_content</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="p">(</span><span class="n">vlen</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_content</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="n">cbox</span> <span class="o">=</span> <span class="n">_c_kvbox</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">klen</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">vlen</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">cbox</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">add_kv_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finishes adding key-value pairs.&quot;&quot;&quot;</span>

        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv_done</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_element_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the total number of key-value pairs.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">_c_long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_element_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">local_element_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the number of key-value pairs locally.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">_c_long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_local_element_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps simply.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map9</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank_zero_only</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps once with a dummy key-value pair.&quot;&quot;&quot;</span>

        <span class="c1">## It needs dummy input; Never inspects.</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map_once</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_once</span><span class="p">(</span><span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">rank_zero_only</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_on_rank_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on rank0 only.&quot;&quot;&quot;</span>

        <span class="c1">## It needs dummy input.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_once</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">mopts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">map_rank_by_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps sequentially with rank by rank for debugging.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_rank_by_rank</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_for_some</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps until some key-value are added.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_for_some</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_ms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps in master-worker mode.&quot;&quot;&quot;</span>

        <span class="c1">## Its call is repeated until True (assuming MPI_SUCCESS==0).</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map_ms</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_ms_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">xopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps in master-worker mode, and runs serial commands.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="n">mopts</span><span class="p">)</span> <span class="o">=</span> <span class="n">_filter_spawn_options</span><span class="p">(</span><span class="n">xopts</span><span class="p">)</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map_ms</span><span class="p">)</span>
        <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms_commands</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_via_spawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">xopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="n">mopts</span><span class="p">)</span> <span class="o">=</span> <span class="n">_filter_spawn_options</span><span class="p">(</span><span class="n">xopts</span><span class="p">)</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_via_spawn</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_mpi_info_null</span><span class="p">,</span> <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonmpi</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_processes</span><span class="p">(</span><span class="n">nonmpi</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_mpi_info_null</span><span class="p">,</span>
                                <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">map_parallel_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_processes</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">map_serial_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_processes</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reduces key-value pairs.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_reduce</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_redfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce9</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">reduce_as_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reduces once as if all pairs had the same key.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_reduce_as_one</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_redfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce_as_one</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">reduce_for_some</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reduces until some key-value are added.&quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_reduce</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_redfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1">## (NOTE: It passes a frame of reduce_for_some.)</span>
        <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">())</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce9</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a new pair by swapping the key and the value.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">mkkvo</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">keyty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reverse</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shuffles key-value pairs.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_shuffle</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_shuffle</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">replicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replicates key-value pairs to be visible on all ranks.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_replicate</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_replicate</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">distribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Distributes pairs approximately evenly to ranks.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_distribute</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_distribute</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">sort_locally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shuffling</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reorders key-value pairs in a single rank.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_sort_locally</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort_locally</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">shuffling</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sorts a KVS globally.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_sort</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">morekvs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Concatenates a number of KVS&#39;es to one.&quot;&quot;&quot;</span>

        <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
        <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">morekvs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ckvsvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_kvs</span> <span class="o">*</span> <span class="n">siz</span><span class="p">)()</span>
        <span class="n">ckvsvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">morekvs</span><span class="p">)):</span>
            <span class="n">ckvsvec</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">morekvs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">_c_int</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_concatenate_kvs</span><span class="p">(</span><span class="n">ckvsvec</span><span class="p">,</span> <span class="n">cn</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">morekvs</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">read_files_reassemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reassembles files reading by ranks.&quot;&quot;&quot;</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">_c_void_p</span><span class="p">()</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="n">_c_uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_files_reassemble</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes_</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">siz</span><span class="p">))</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">read_file_by_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads one file by segments and reassembles.&quot;&quot;&quot;</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">_c_void_p</span><span class="p">()</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="n">_c_uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_file_by_segments</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">siz</span><span class="p">))</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Packs locally the contents of a KVS to a byte array.&quot;&quot;&quot;</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">_c_void_p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="n">_c_size_t</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_save_kvs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">siz</span><span class="p">),</span>
                           <span class="n">_c_option</span><span class="p">())</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unpacks locally the contents of a KVS from a byte array.&quot;&quot;&quot;</span>

        <span class="n">kvo</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">)</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="p">)</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_restore_kvs</span><span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">kvo</span>

    <span class="k">def</span> <span class="nf">_map_swf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">xopts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;.&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="n">mopts</span><span class="p">)</span> <span class="o">=</span> <span class="n">_filter_spawn_options</span><span class="p">(</span><span class="n">xopts</span><span class="p">)</span>
        <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
        <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
        <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
        <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_swf</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#kmr4py.KVS">KVS</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, kmr_or_ckvs, keyty=&#39;opaque&#39;, valty=&#39;opaque&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Makes a KVS for a given KMR.  Do not call the KVS constructor
directly, but use KMR.make_kvs() instead.  A KVS is created
with the datatypes stored in the key and the value, specified
by the keywords "key=" and "value=".  The datatype name is a
string, one of "opaque", "cstring", "integer", and "float8".
Most mappers and reducers (precisely, the methods that accepts
a function argument) take keyword arguments for the types,
defaulting with key="opaque" and value="opaque".  The
datatypes affects the sorting order.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.__init__', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kmr_or_ckvs</span><span class="p">,</span> <span class="n">keyty</span><span class="o">=</span><span class="s2">&quot;opaque&quot;</span><span class="p">,</span> <span class="n">valty</span><span class="o">=</span><span class="s2">&quot;opaque&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a KVS for a given KMR.  Do not call the KVS constructor</span>
<span class="sd">    directly, but use KMR.make_kvs() instead.  A KVS is created</span>
<span class="sd">    with the datatypes stored in the key and the value, specified</span>
<span class="sd">    by the keywords &quot;key=&quot; and &quot;value=&quot;.  The datatype name is a</span>
<span class="sd">    string, one of &quot;opaque&quot;, &quot;cstring&quot;, &quot;integer&quot;, and &quot;float8&quot;.</span>
<span class="sd">    Most mappers and reducers (precisely, the methods that accepts</span>
<span class="sd">    a function argument) take keyword arguments for the types,</span>
<span class="sd">    defaulting with key=&quot;opaque&quot; and value=&quot;opaque&quot;.  The</span>
<span class="sd">    datatypes affects the sorting order.  &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;mr attribute holds a KMR context object.  Note that mr is</span>
<span class="sd">    not accessible from mapping/reducing functions.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;_ckvs attribute holds a kvs in C.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_frameinfo</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;_frameinfo protects caller line information from garbage</span>
<span class="sd">    collected.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kmr_or_ckvs</span><span class="p">,</span> <span class="n">KMR</span><span class="p">):</span>
        <span class="n">kf</span> <span class="o">=</span> <span class="n">_field_name_type_map</span><span class="p">[</span><span class="n">keyty</span><span class="p">]</span>
        <span class="n">vf</span> <span class="o">=</span> <span class="n">_field_name_type_map</span><span class="p">[</span><span class="n">valty</span><span class="p">]</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="n">kmr_or_ckvs</span>
        <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_create_kvs7</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">(),</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frameinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kmr_or_ckvs</span><span class="p">,</span> <span class="n">_c_pointer</span><span class="p">):</span>
        <span class="c1">## Return a dummy KVS.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">kmr_or_ckvs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad call to kvs constructor&quot;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.add">
    <p>def <span class="ident">add</span>(</p><p>self, key, val)</p>
    </div>
    

    
  
    <div class="desc"><p>Adds a key-value pair.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.add', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.add" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds a key-value pair.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_kv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.add_kv">
    <p>def <span class="ident">add_kv</span>(</p><p>self, key, val)</p>
    </div>
    

    
  
    <div class="desc"><p>Adds a key-value pair.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.add_kv', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.add_kv" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add_kv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds a key-value pair.&quot;&quot;&quot;</span>
    <span class="c1">## Note it keeps the created string until kmr_add_kv(),</span>
    <span class="c1">## because kvbox does not hold the references.</span>
    <span class="p">(</span><span class="n">klen</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ks</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_content</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
    <span class="p">(</span><span class="n">vlen</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_content</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="n">cbox</span> <span class="o">=</span> <span class="n">_c_kvbox</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">klen</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">vlen</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">cbox</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.add_kv_done">
    <p>def <span class="ident">add_kv_done</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Finishes adding key-value pairs.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.add_kv_done', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.add_kv_done" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add_kv_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finishes adding key-value pairs.&quot;&quot;&quot;</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_add_kv_done</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.concatenate">
    <p>def <span class="ident">concatenate</span>(</p><p>self, *morekvs)</p>
    </div>
    

    
  
    <div class="desc"><p>Concatenates a number of KVS'es to one.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.concatenate', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.concatenate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">morekvs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Concatenates a number of KVS&#39;es to one.&quot;&quot;&quot;</span>
    <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
    <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">morekvs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ckvsvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_kvs</span> <span class="o">*</span> <span class="n">siz</span><span class="p">)()</span>
    <span class="n">ckvsvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">morekvs</span><span class="p">)):</span>
        <span class="n">ckvsvec</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">morekvs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">cn</span> <span class="o">=</span> <span class="n">_c_int</span><span class="p">(</span><span class="n">siz</span><span class="p">)</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_concatenate_kvs</span><span class="p">(</span><span class="n">ckvsvec</span><span class="p">,</span> <span class="n">cn</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">morekvs</span><span class="p">:</span>
        <span class="n">i</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.distribute">
    <p>def <span class="ident">distribute</span>(</p><p>self, cyclic, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Distributes pairs approximately evenly to ranks.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.distribute', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.distribute" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">distribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Distributes pairs approximately evenly to ranks.&quot;&quot;&quot;</span>
    <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
    <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_distribute</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_distribute</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.free">
    <p>def <span class="ident">free</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Finishes the C part of a KVS.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.free', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.free" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finishes the C part of a KVS.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_dummy</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad call to free_kvs on dummy KVS&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad call to free_kvs on freed KVS&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_dismissed</span><span class="p">):</span>
        <span class="c1">## Do not free when KMR object is dismissed.</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_free_kvs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span> <span class="o">=</span> <span class="n">_c_null_pointer_value</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.get_element_count">
    <p>def <span class="ident">get_element_count</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Gets the total number of key-value pairs.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.get_element_count', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.get_element_count" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_element_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the total number of key-value pairs.&quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">_c_long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_element_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.get_field_type">
    <p>def <span class="ident">get_field_type</span>(</p><p>self, key_or_value)</p>
    </div>
    

    
  
    <div class="desc"><p>Get a field type of a KVS.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.get_field_type', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.get_field_type" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_field_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_or_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a field type of a KVS.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_c_null_pointer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad KVS (null C-object)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">key_or_value</span> <span class="o">==</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
        <span class="n">kvty</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_key_type_ff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">key_or_value</span> <span class="o">==</span> <span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">):</span>
        <span class="n">kvty</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_get_value_type_ff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key_or_value</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kvty</span> <span class="o">==</span> <span class="n">_kv_bad</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad field type value </span><span class="si">%d</span><span class="s2"> in KVS&quot;</span> <span class="o">%</span> <span class="n">kvty</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_field_type_name_map</span><span class="p">[</span><span class="n">kvty</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.local_element_count">
    <p>def <span class="ident">local_element_count</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Gets the number of key-value pairs locally.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.local_element_count', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.local_element_count" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">local_element_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the number of key-value pairs locally.&quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">_c_long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_local_element_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map">
    <p>def <span class="ident">map</span>(</p><p>self, fn, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps simply.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps simply.&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map9</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_for_some">
    <p>def <span class="ident">map_for_some</span>(</p><p>self, fn, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps until some key-value are added.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_for_some', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_for_some" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_for_some</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps until some key-value are added.&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_for_some</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_ms">
    <p>def <span class="ident">map_ms</span>(</p><p>self, fn, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps in master-worker mode.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_ms', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_ms" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_ms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps in master-worker mode.&quot;&quot;&quot;</span>
    <span class="c1">## Its call is repeated until True (assuming MPI_SUCCESS==0).</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map_ms</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_ms_commands">
    <p>def <span class="ident">map_ms_commands</span>(</p><p>self, fn, **xopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps in master-worker mode, and runs serial commands.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_ms_commands', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_ms_commands" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_ms_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">xopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps in master-worker mode, and runs serial commands.&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="n">mopts</span><span class="p">)</span> <span class="o">=</span> <span class="n">_filter_spawn_options</span><span class="p">(</span><span class="n">xopts</span><span class="p">)</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map_ms</span><span class="p">)</span>
    <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">rr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_ms_commands</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_on_rank_zero">
    <p>def <span class="ident">map_on_rank_zero</span>(</p><p>self, fn, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps on rank0 only.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_on_rank_zero', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_on_rank_zero" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_on_rank_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps on rank0 only.&quot;&quot;&quot;</span>
    <span class="c1">## It needs dummy input.</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_once</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">mopts</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_once">
    <p>def <span class="ident">map_once</span>(</p><p>self, rank_zero_only, fn, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps once with a dummy key-value pair.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_once', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_once" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank_zero_only</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps once with a dummy key-value pair.&quot;&quot;&quot;</span>
    <span class="c1">## It needs dummy input; Never inspects.</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map_once</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_once</span><span class="p">(</span><span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">rank_zero_only</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_parallel_processes">
    <p>def <span class="ident">map_parallel_processes</span>(</p><p>self, fn, **sopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps on processes started by MPI_Comm_spawn().</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_parallel_processes', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_parallel_processes" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_parallel_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_processes</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_processes">
    <p>def <span class="ident">map_processes</span>(</p><p>self, nonmpi, fn, **sopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps on processes started by MPI_Comm_spawn().</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_processes', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_processes" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonmpi</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_processes</span><span class="p">(</span><span class="n">nonmpi</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_mpi_info_null</span><span class="p">,</span>
                            <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_rank_by_rank">
    <p>def <span class="ident">map_rank_by_rank</span>(</p><p>self, fn, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps sequentially with rank by rank for debugging.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_rank_by_rank', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_rank_by_rank" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_rank_by_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps sequentially with rank by rank for debugging.&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_rank_by_rank</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_serial_processes">
    <p>def <span class="ident">map_serial_processes</span>(</p><p>self, fn, **sopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps on processes started by MPI_Comm_spawn().</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_serial_processes', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_serial_processes" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_serial_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_processes</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">sopts</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.map_via_spawn">
    <p>def <span class="ident">map_via_spawn</span>(</p><p>self, fn, **xopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Maps on processes started by MPI_Comm_spawn().</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.map_via_spawn', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.map_via_spawn" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_via_spawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">xopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps on processes started by MPI_Comm_spawn().&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">sopts</span><span class="p">,</span> <span class="n">mopts</span><span class="p">)</span> <span class="o">=</span> <span class="n">_filter_spawn_options</span><span class="p">(</span><span class="n">xopts</span><span class="p">)</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
    <span class="n">csopts</span> <span class="o">=</span> <span class="n">_c_spawn_option</span><span class="p">(</span><span class="n">sopts</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_mapfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_map_via_spawn</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_mpi_info_null</span><span class="p">,</span> <span class="n">csopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.read_file_by_segments">
    <p>def <span class="ident">read_file_by_segments</span>(</p><p>self, filename, color)</p>
    </div>
    

    
  
    <div class="desc"><p>Reads one file by segments and reassembles.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.read_file_by_segments', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.read_file_by_segments" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">read_file_by_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads one file by segments and reassembles.&quot;&quot;&quot;</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">_c_void_p</span><span class="p">()</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">_c_uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_file_by_segments</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">siz</span><span class="p">))</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.read_files_reassemble">
    <p>def <span class="ident">read_files_reassemble</span>(</p><p>self, filename, color, offset, bytes_)</p>
    </div>
    

    
  
    <div class="desc"><p>Reassembles files reading by ranks.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.read_files_reassemble', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.read_files_reassemble" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">read_files_reassemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reassembles files reading by ranks.&quot;&quot;&quot;</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">_c_void_p</span><span class="p">()</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">_c_uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_read_files_reassemble</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">_ckmr</span><span class="p">,</span> <span class="n">_encode</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes_</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">siz</span><span class="p">))</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.reduce">
    <p>def <span class="ident">reduce</span>(</p><p>self, fn, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Reduces key-value pairs.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.reduce', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.reduce" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reduces key-value pairs.&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_reduce</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_redfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce9</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.reduce_as_one">
    <p>def <span class="ident">reduce_as_one</span>(</p><p>self, fn, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Reduces once as if all pairs had the same key.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.reduce_as_one', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.reduce_as_one" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">reduce_as_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reduces once as if all pairs had the same key.&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_reduce_as_one</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_redfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce_as_one</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.reduce_for_some">
    <p>def <span class="ident">reduce_for_some</span>(</p><p>self, fn, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Reduces until some key-value are added.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.reduce_for_some', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.reduce_for_some" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">reduce_for_some</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reduces until some key-value are added.&quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_reduce</span><span class="p">)</span>
    <span class="n">cfn</span> <span class="o">=</span> <span class="n">_wrap_redfn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1">## (NOTE: It passes a frame of reduce_for_some.)</span>
    <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">_make_frame_info</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">())</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reduce9</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">,</span> <span class="n">cfn</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.replicate">
    <p>def <span class="ident">replicate</span>(</p><p>self, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Replicates key-value pairs to be visible on all ranks.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.replicate', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.replicate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">replicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replicates key-value pairs to be visible on all ranks.&quot;&quot;&quot;</span>
    <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
    <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_replicate</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_replicate</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.restore">
    <p>def <span class="ident">restore</span>(</p><p>self, data)</p>
    </div>
    

    
  
    <div class="desc"><p>Unpacks locally the contents of a KVS from a byte array.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.restore', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.restore" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unpacks locally the contents of a KVS from a byte array.&quot;&quot;&quot;</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">,</span> <span class="s2">&quot;opaque&quot;</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="p">)</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_restore_kvs</span><span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="p">,</span> <span class="n">_c_option</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.reverse">
    <p>def <span class="ident">reverse</span>(</p><p>self, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Makes a new pair by swapping the key and the value.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.reverse', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.reverse" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a new pair by swapping the key and the value.&quot;&quot;&quot;</span>
    <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
    <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_map</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">mkkvo</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">valty</span><span class="p">,</span> <span class="n">keyty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_reverse</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.save">
    <p>def <span class="ident">save</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Packs locally the contents of a KVS to a byte array.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.save', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.save" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Packs locally the contents of a KVS to a byte array.&quot;&quot;&quot;</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">_c_void_p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="n">_c_size_t</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_save_kvs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">siz</span><span class="p">),</span>
                       <span class="n">_c_option</span><span class="p">())</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">_c_ubyte</span> <span class="o">*</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_mfree</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">siz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.shuffle">
    <p>def <span class="ident">shuffle</span>(</p><p>self, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Shuffles key-value pairs.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.shuffle', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.shuffle" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shuffles key-value pairs.&quot;&quot;&quot;</span>
    <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
    <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_shuffle</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_shuffle</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.sort">
    <p>def <span class="ident">sort</span>(</p><p>self, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Sorts a KVS globally.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.sort', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.sort" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sorts a KVS globally.&quot;&quot;&quot;</span>
    <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
    <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_sort</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="kmr4py.KVS.sort_locally">
    <p>def <span class="ident">sort_locally</span>(</p><p>self, shuffling, **mopts)</p>
    </div>
    

    
  
    <div class="desc"><p>Reorders key-value pairs in a single rank.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-kmr4py.KVS.sort_locally', this);">Show source &equiv;</a></p>
  <div id="source-kmr4py.KVS.sort_locally" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">sort_locally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shuffling</span><span class="p">,</span> <span class="o">**</span><span class="n">mopts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reorders key-value pairs in a single rank.&quot;&quot;&quot;</span>
    <span class="n">keyty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span>
    <span class="n">valty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_type</span><span class="p">(</span><span class="n">_Slot</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mkkvo</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_options</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">cmopts</span> <span class="o">=</span> <span class="n">_c_option</span><span class="p">(</span><span class="n">mopts</span><span class="p">,</span> <span class="n">_enabled_options_of_sort_locally</span><span class="p">)</span>
    <span class="n">ckvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckvs</span>
    <span class="n">kvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">KVS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">,</span> <span class="n">keyty</span><span class="p">,</span> <span class="n">valty</span><span class="p">)</span> <span class="k">if</span> <span class="n">mkkvo</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ckvo</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvo</span><span class="o">.</span><span class="n">_ckvs</span> <span class="k">if</span> <span class="p">(</span><span class="n">kvo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kmrso</span><span class="o">.</span><span class="n">kmr_sort_locally</span><span class="p">(</span><span class="n">ckvi</span><span class="p">,</span> <span class="n">ckvo</span><span class="p">,</span> <span class="n">shuffling</span><span class="p">,</span> <span class="n">cmopts</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmopts</span><span class="o">.</span><span class="n">inspect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consume</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kvo</span>
</pre></div>

  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="kmr4py.KVS.mr" class="name">var <span class="ident">mr</span></p>
            

            
  
    <div class="desc"><p>mr attribute holds a KMR context object.  Note that mr is
not accessible from mapping/reducing functions.</p></div>
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>